#==========================================================================
# Description: Build Flash Images for efused devices
# Copyright (C) 2025 https://github.com/dd-ray/amlogic-s9xxx-armbian
#==========================================================================

name: Build Flash Images

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      source_release_tag:
        description: "ä»å“ªä¸ªreleaseè·å–æºé•œåƒ"
        required: false
        default: "Armbian_bookworm_save_2025.06"
        type: string
      build_device:
        description: "é€‰æ‹©æ„å»ºè®¾å¤‡"
        required: false
        default: "efused-wxy-oec"
        type: choice
        options:
          - efused-wxy-oec
      flash_release_tag:
        description: "Flashé•œåƒå‘å¸ƒæ ‡ç­¾"
        required: false
        default: "Armbian_debian"
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-flash-images:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        id: init
        run: |
          echo "æ„å»ºç¯å¢ƒåˆå§‹åŒ–..."
          sudo apt-get update -qq
          sudo apt-get install -qq -y gdisk parted zip unzip curl wget jq tar
          
          # è®¾ç½®å·¥ä½œç›®å½•
          FLASH_WORKSPACE="${GITHUB_WORKSPACE}/flash_build"
          mkdir -p "${FLASH_WORKSPACE}"
          echo "FLASH_WORKSPACE=${FLASH_WORKSPACE}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date +"%Y.%m.%d.%H%M")" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=${{ inputs.flash_release_tag || 'Armbian_debian' }}" >> $GITHUB_OUTPUT
          echo "SOURCE_TAG=${{ inputs.source_release_tag || 'Armbian_bookworm_save_2025.06' }}" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æºé•œåƒæ–‡ä»¶
        id: download
        run: |
          echo "ä» release ${{ steps.init.outputs.SOURCE_TAG }} ä¸‹è½½æºé•œåƒ..."
          
          # è·å–releaseä¿¡æ¯
          RELEASE_INFO=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.init.outputs.SOURCE_TAG }}")
          
          # æ ¹æ®è®¾å¤‡ç±»å‹é€‰æ‹©è¦ä¸‹è½½çš„é•œåƒ
          DEVICE_PATTERN="${{ inputs.build_device || 'efused-wxy-oec' }}"
          
          if [[ "${DEVICE_PATTERN}" == "efused-wxy-oec" ]]; then
            # è·å–æ‰€æœ‰åŒ¹é…è®¾å¤‡çš„é•œåƒæ–‡ä»¶ï¼Œå¹¶æŒ‰æ—¥æœŸæ’åºé€‰æ‹©æœ€æ–°çš„
            echo "æŸ¥æ‰¾æ‰€æœ‰åŒ¹é… '${DEVICE_PATTERN}' çš„é•œåƒæ–‡ä»¶..."
            
            # è·å–æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶åå’Œå¯¹åº”çš„ä¸‹è½½é“¾æ¥
            MATCHING_FILES=$(echo "${RELEASE_INFO}" | jq -r '.assets[] | select(.name | contains("efused-wxy-oec") and (endswith(".img.gz") or endswith(".img.xz") or endswith(".img"))) | "\(.name)|\(.browser_download_url)"')
            
            if [[ -z "${MATCHING_FILES}" ]]; then
              echo "æœªæ‰¾åˆ°åŒ¹é…çš„é•œåƒæ–‡ä»¶"
              exit 1
            fi
            
            echo "æ‰¾åˆ°çš„é•œåƒæ–‡ä»¶ï¼š"
            echo "${MATCHING_FILES}"
            
            # è§£ææ–‡ä»¶åä¸­çš„æ—¥æœŸå¹¶æ‰¾åˆ°æœ€æ–°çš„
            LATEST_FILE=""
            LATEST_DATE=""
            LATEST_URL=""
            
            while IFS='|' read -r filename download_url; do
              # ä»æ–‡ä»¶åä¸­æå–æ—¥æœŸ (æ ¼å¼: YYYY.MM.DD)
              DATE_PART=$(echo "${filename}" | grep -oE '[0-9]{4}\.[0-9]{2}\.[0-9]{2}' | tail -1)
              
              if [[ -n "${DATE_PART}" ]]; then
                echo "æ–‡ä»¶: ${filename} -> æ—¥æœŸ: ${DATE_PART}"
                
                # å°†æ—¥æœŸè½¬æ¢ä¸ºå¯æ¯”è¾ƒçš„æ ¼å¼ (YYYYMMDD)
                COMPARABLE_DATE=$(echo "${DATE_PART}" | sed 's/\.//g')
                
                if [[ -z "${LATEST_DATE}" ]] || [[ "${COMPARABLE_DATE}" > "${LATEST_DATE}" ]]; then
                  LATEST_DATE="${COMPARABLE_DATE}"
                  LATEST_FILE="${filename}"
                  LATEST_URL="${download_url}"
                fi
              else
                echo "è­¦å‘Š: æ–‡ä»¶ ${filename} ä¸­æœªæ‰¾åˆ°æ—¥æœŸä¿¡æ¯"
              fi
            done <<< "${MATCHING_FILES}"
            
            if [[ -z "${LATEST_FILE}" ]]; then
              echo "æœªæ‰¾åˆ°å¸¦æœ‰æ—¥æœŸä¿¡æ¯çš„é•œåƒæ–‡ä»¶"
              exit 1
            fi
            
            FILENAME="${LATEST_FILE}"
            DOWNLOAD_URL="${LATEST_URL}"
            ORIGINAL_DATE="${LATEST_DATE:0:4}.${LATEST_DATE:4:2}.${LATEST_DATE:6:2}"
            
            echo "é€‰æ‹©æœ€æ–°é•œåƒ: ${FILENAME} (æ—¥æœŸ: ${ORIGINAL_DATE})"
          else
            # ä¸‹è½½æ‰€æœ‰æ”¯æŒçš„è®¾å¤‡é•œåƒ
            echo "æš‚æ—¶åªæ”¯æŒ efused-wxy-oec è®¾å¤‡"
            exit 1
          fi
          
          if [[ -z "${DOWNLOAD_URL}" || "${DOWNLOAD_URL}" == "null" ]]; then
            echo "æœªæ‰¾åˆ°åŒ¹é…çš„é•œåƒæ–‡ä»¶"
            exit 1
          fi
          
          echo "ä¸‹è½½æ–‡ä»¶: ${FILENAME}"
          echo "ä¸‹è½½é“¾æ¥: ${DOWNLOAD_URL}"
          
          # ä¸‹è½½æ–‡ä»¶
          cd "${{ steps.init.outputs.FLASH_WORKSPACE }}"
          wget -O "${FILENAME}" "${DOWNLOAD_URL}"
          
          echo "SOURCE_IMAGE=${FILENAME}" >> $GITHUB_OUTPUT
          echo "SOURCE_PATH=${{ steps.init.outputs.FLASH_WORKSPACE }}/${FILENAME}" >> $GITHUB_OUTPUT

      - name: æ„å»ºFlashé•œåƒ
        id: build_flash
        run: |
          echo "å¼€å§‹æ„å»ºFlashé•œåƒ..."
          
          cd "${{ steps.init.outputs.FLASH_WORKSPACE }}"
          
          # è¿è¡ŒFlashé•œåƒæ„å»ºè„šæœ¬
          sudo bash "${GITHUB_WORKSPACE}/build-armbian/create-flash-image.sh" \
            "${{ steps.download.outputs.SOURCE_PATH }}" \
            "${{ inputs.build_device || 'efused-wxy-oec' }}" \
            "${{ steps.init.outputs.FLASH_WORKSPACE }}"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„Flashé•œåƒ
          FLASH_IMAGE=$(ls Flash_*.zip | head -1)
          
          if [[ -z "${FLASH_IMAGE}" ]]; then
            echo "Flashé•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "æ„å»ºå®Œæˆ: ${FLASH_IMAGE}"
          echo "FLASH_IMAGE=${FLASH_IMAGE}" >> $GITHUB_OUTPUT
          echo "FLASH_PATH=${{ steps.init.outputs.FLASH_WORKSPACE }}/${FLASH_IMAGE}" >> $GITHUB_OUTPUT
          
          # ç”ŸæˆSHA256æ ¡éªŒæ–‡ä»¶
          sha256sum "${FLASH_IMAGE}" > "${FLASH_IMAGE}.sha256"
          echo "SHA256_FILE=${FLASH_IMAGE}.sha256" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒFlashé•œåƒåˆ°Release
        uses: ncipollo/release-action@main
        with:
          tag: ${{ steps.init.outputs.RELEASE_TAG }}
          name: ${{ steps.init.outputs.RELEASE_TAG }}
          body: |
            ## ğŸ“¦ Flash é•œåƒå‘å¸ƒ

            **æ„å»ºä¿¡æ¯ï¼š**
            - æºé•œåƒ: ${{ steps.download.outputs.SOURCE_IMAGE }}
            - Flashé•œåƒ: ${{ steps.build_flash.outputs.FLASH_IMAGE }}
            - è®¾å¤‡ç±»å‹: ${{ inputs.build_device || 'efused-wxy-oec' }}
            - æ„å»ºæ—¶é—´: ${{ steps.init.outputs.BUILD_DATE }}

            ## ğŸ“‹ åˆ†åŒºç»“æ„

            Flashé•œåƒåŒ…å«å®Œæ•´çš„7ä¸ªåˆ†åŒºç»“æ„ï¼š

            | åˆ†åŒºå· | åˆ†åŒºå | å¤§å° | æè¿° |
            |--------|--------|------|------|
            | 1 | uboot | 4MB | U-Boot åˆ†åŒº (åŸå‚) |
            | 2 | misc | 4MB | æ‚é¡¹åˆ†åŒº (åŸå‚) |
            | 3 | boot | 64MB | å¯åŠ¨åˆ†åŒº (åŸå‚) |
            | 4 | kernel | 64MB | å†…æ ¸åˆ†åŒº (åŸå‚) |
            | 5 | env | 32MB | ç¯å¢ƒå˜é‡åˆ†åŒº (åŸå‚) |
            | 6 | boot | 512MB | Armbian å¯åŠ¨åˆ†åŒº |
            | 7 | rootfs | å‰©ä½™ç©ºé—´ | Armbian æ ¹æ–‡ä»¶ç³»ç»Ÿ |

            ## ğŸ’¡ ä½¿ç”¨æ–¹æ³•

            1. **ä¸‹è½½æ–‡ä»¶**: ä¸‹è½½Flashé•œåƒzipæ–‡ä»¶å’Œå¯¹åº”çš„SHA256æ ¡éªŒæ–‡ä»¶
            2. **éªŒè¯å®Œæ•´æ€§**: 
               ```bash
               sha256sum -c *.sha256
               ```
            3. **è§£å‹é•œåƒ**: 
               ```bash
               unzip ${{ steps.build_flash.outputs.FLASH_IMAGE }}
               ```
            4. **åˆ·å†™åˆ°è®¾å¤‡**: ä½¿ç”¨ `rkdevtool` æˆ–ç±»ä¼¼å·¥å…·å†™å…¥åˆ°è®¾å¤‡Flashå­˜å‚¨

            ## âš ï¸ é‡è¦æé†’

            - **å¤‡ä»½æ•°æ®**: Flashé•œåƒåŒ…å«å®Œæ•´çš„7ä¸ªåˆ†åŒºï¼Œä¼šè¦†ç›–æ‰€æœ‰åŸæœ‰æ•°æ®
            - **ç¡®è®¤è®¾å¤‡**: ç¡®ä¿é•œåƒé€‚ç”¨äºæ‚¨çš„è®¾å¤‡å‹å·ï¼Œé”™è¯¯çš„é•œåƒå¯èƒ½å¯¼è‡´è®¾å¤‡æ— æ³•å¯åŠ¨  
            - **æ–­ç”µé£é™©**: åˆ·å†™è¿‡ç¨‹ä¸­ä¸è¦æ–­ç”µæˆ–æ‹”é™¤è®¾å¤‡
            - **åŸå‚å›ºä»¶**: å»ºè®®åˆ·å†™å‰å¤‡ä»½åŸå‚å›ºä»¶ä»¥ä¾¿æ¢å¤

            ---
            
            ğŸ”§ **æŠ€æœ¯æ”¯æŒ**: [Issues](https://github.com/${{ github.repository }}/issues) | ğŸ“– **è¯¦ç»†æ–‡æ¡£**: [README](https://github.com/${{ github.repository }}/blob/main/README-Flash-Build.md)
          artifacts: "${{ steps.init.outputs.FLASH_WORKSPACE }}/${{ steps.build_flash.outputs.FLASH_IMAGE }},${{ steps.init.outputs.FLASH_WORKSPACE }}/${{ steps.build_flash.outputs.SHA256_FILE }}"
          allowUpdates: true
          updateOnlyUnreleased: false
          replacesArtifacts: true
          makeLatest: false
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          sudo rm -rf "${{ steps.init.outputs.FLASH_WORKSPACE }}" 2>/dev/null || true

      - name: æ„å»ºæ€»ç»“
        if: success()
        run: |
          echo "ğŸ‰ Flashé•œåƒæ„å»ºæˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ æ„å»ºä¿¡æ¯ï¼š"
          echo "  - æºé•œåƒ: ${{ steps.download.outputs.SOURCE_IMAGE }}"
          echo "  - Flashé•œåƒ: ${{ steps.build_flash.outputs.FLASH_IMAGE }}"
          echo "  - è®¾å¤‡ç±»å‹: ${{ inputs.build_device || 'efused-wxy-oec' }}"
          echo "  - Release: ${{ steps.init.outputs.RELEASE_TAG }}"
          echo ""
          echo "ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š"
          echo "  1. ä» https://github.com/${{ github.repository }}/releases/tag/${{ steps.init.outputs.RELEASE_TAG }} ä¸‹è½½Flashé•œåƒ"
          echo "  2. è§£å‹zipæ–‡ä»¶å¾—åˆ°imgé•œåƒ"
          echo "  3. ä½¿ç”¨rkdevtoolå†™å…¥åˆ°è®¾å¤‡Flashå­˜å‚¨"
          echo ""
          echo "âš ï¸  æ³¨æ„ï¼šFlashé•œåƒåŒ…å«å®Œæ•´çš„7ä¸ªåˆ†åŒºï¼Œåˆ·å…¥å‰è¯·å¤‡ä»½é‡è¦æ•°æ®ï¼" 